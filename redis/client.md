# 客户端

## 客户端属性

### 套接字描述符

fd，根据客户端类型的不同，其值可为-1或大于-1的整数。

* -1时，伪客户端：其处理的命令请求来源于AOF文件或Lua脚本，而不是网络，不需要套接字连接，也就不需要记录文件描述符。
* 大于-1的整数，普通客户端

### 名字

CLIENT setname命令可以为客户端设置一个名字，让客户端的身份变得清晰。其记录在name属性中。

### 标志

flags属性记录了客户端的角色，以及客户端目前所处的状态。

### 输入缓冲区

用于保存客户端发送的命令请求，querybuf属性

### 命令与命令参数

argv: 命令参数，其中argv\[0\]是要执行的命令 argc: 命令参数的个数

### 命令的实现函数

cmd属性记录客户端要执行命令的实现函数。，redisCommand结构，保存了命令的实现函数、命令的标志、命令应该给定的参数个数、命令的总执行次数和总消耗时长等统计信息。

### 输出缓冲区

buf和bufpos： 固定大小的缓冲区

reply链表：可变大小缓冲区

### 身份验证

authenticated 属性记录客户端是否通过了身份验证

### 时间

ctime记录创建客户端的时间，计算客户端与服务器已经连接了多少时间，CLIENT list命令的age域记录了这个时间

lastinteraction记录客户端与服务器最后一次进行互动的时间。可以用于计算客户端的空转时间。

obuf\_soft\_limit\_reached\_time属性记录输出缓冲区第一次到达软性限制的时间。

## 客户端的创建与关闭

### 创建普通客户端

客户端 -&gt; connect函数 -&gt; 服务器 -&gt; 连接事件处理器 -&gt; 创建客户端状态，加到clients链表尾部。

### 关闭普通客户端

当一个客户端通过网络连接连上服务器时，服务器会为这个客户端创建相应的客户端状态。网络连接关闭、发送了不合协议格式的命令请求、成为CLIENT KILL命令的目标、空转时间超时、输出缓冲区的大小超过限制，以上这些原因都会造成客户端被关闭。

客户端有固定大小缓冲区和可变大小缓冲区两种缓冲区可用，其中固定大小缓冲区的最大大小为16KB，而可变大小缓冲区的最大大小不能超过服务器设置的硬性限制值。

输出缓冲区限制值有两种，如果输出缓冲区的大小超过了服务器设置的硬性限制，那么客户端会被立即关闭；除此之外，如果客户端在一定时间内，一直超过服务器设置的软性限制，那么客户端会被关闭。

### Lua脚本的伪客户端

lua\_client

处理Lua脚本的伪客户端在服务器初始化时创建，这个客户端会一直存在，直到服务器关闭。

### AOF文件的伪客户端

载入AOF文件时使用的伪客户端在载入工作开始时动态创建，载入工作完毕后关闭。

