# 数据库

## 服务器中的数据库

server.h/redisServer中的redisDb *db保存着服务器中的所有数据库。dbnum决定创建多少个数据库，其属性由服务器database选项决定，默认16。

## 切换数据库

默认客户端目标数据库为0号数据库，SELECT命令可以切换数据库（通过修改client.db指针，让它指向服务器中的不同数据库，从而实现切换目标数据库的功能）。
server.h/client中的redisDb *db记录客户端当前正在使用的数据库

## 数据库键空间

redisDb中的dict *dict即数据库键空间，保存着数据库中的所有键值对。

### 添加新键

添加一个新键值对到数据库，实际上就是添加一个新键值到键空间字典里面。

### 删除键

删除数据库中的一个键，实际就是在键空间中删除键所对应的键值对对象。

### 更新键

对一个数据库键进行更新，实际就是对键空间里面键所对应的值对象进行更新。

### 对键取值

对一个数据库键进行取值，实际就是在键空间中取出键所对应的值对象。

### 其他键空间操作

FLUSHDB: 删除键空间中的所有键值对
RANDOMKEY: 在键空间中随机返回一个键
DBSIZE: 返回键空间中包含的键值对数量
EXISTS、RENAME、KEYS等都是通过对键空间进行操作来实现的

### 读写键空间时的维护操作

- 在读取一个键之后，服务器会根据键是否存在来更新服务器的键空间命中（hit）次数和键空间不命中（miss）次数。
  - INFO stats -> keyspace_hits和keyspace_misses
- 在读取一个键之后，服务器会更新键的LRU时间，这个值可以用于计算键的闲置时间。
  - OBJECT idletime命令
- 如果服务器在读取一个键时发现该键已经过期，那么服务器会先删除这个过期键，然后才指向余下的其他草果
- 如果由客户端使用WATCH命令监视了某个键，那么服务器在对被监视的键进行修改后，会将这个键标记为脏（dirty），从而让事务程序注意到这个键已经被修改过。
- 服务器每次修改一个键之后，都会对脏（dirty）键计数器的值增1，这个计数器会触发服务器的持久化以及复制操作。
- 如果服务器开启了数据库通知功能，那么在对键进行修改之后，服务器将按配置发送相应的数据库通知。

### 设置键的生存时间或过期时间

- 相关命令
  - EXPIRE\<key>\<ttl> 将键key的生存时间设置为ttl秒
  - PEXPIRE\<key>\<ttl> 将键key的生存时间设置为ttl毫秒
  - EXPIREAT\<key>\<timpstamp> 将键key的过期时间设置为timestamp所指定的秒数时间戳
  - PEXPIREAT\<key>\<timpstamp> 键键key的过期时间设置为timestamp所指定的毫秒数时间戳
  - TTL 以秒为单位返回键的剩余生存时间
  - PTTL 以毫秒为单位返回键的剩余生存时间
  - PERSIST 移除一个键的过期时间
- 过期字典
  - dict *expires保存着键的过期时间
- 过期键的判定
  - 检查给定键是否存在于过期字典：如果存在，那么取得键的过期时间
  - 检查当前UNIX时间戳是否大于键的过期时间：如果是的话，那么键以及过期；否则键未过期

### 过期键删除策略

- 定时删除

  在设置键的过期时间的同时，创建一个定时器，让定时器在键的过期时间来临时，立即执行对键的删除操作。

  - 对内存友好：可以保证过期键尽可能快地被删除，并释放过期键所占用的内存
  - 对CPU时间最不友好：过期键比较多的情况下，删除过期键可能会占用相当一部分CPU时间
- 惰性删除
  放任键过期不管，但是每次从键空间中获取键时，都检查取得的键是否过期，如果过期的话，就删除该键；如果没有过期，就返回该键。

  - 对CPU时间最友好
  - 对内存最不友好
- 定期删除
  每隔一段时间，程序对数据库进行一次检查，删除里面的过期键。至于到删除多少过期键，以及要检查多少个数据库，由算法决定

  合理设置删除操作的执行时长和执行频率

### Redis的过期键删除策略

通过配合使用惰性删除和定期删除两种策略，服务器可以很好地在合理使用CPU时间和避免浪费内存空间之间取得平衡

#### 惰性删除策略的实现

db.c/expireIfNeeded

#### 定期删除策略的实现

- 定期删除策略实现 expire.c/activeExpireCycle
  - 函数每次运行时，都从一定数量的数据库中取出一定数量的随机键进行检查，并删除其中的过期键
  - 全局遍历current_db记录当前activeExpireCycle函数检查的进度，并在下一次activeExpireCycle函数调用时，接着上一次的进度进行处理。
  - 随着activeExpireCycle函数的不断执行，服务器中的所有数据库都会被检查一遍，这是函数将current_db变量重置为0，然后再次开启新一轮的检查工作
- Redis的服务器周期性操作 server.c/databaseCron
