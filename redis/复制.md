# 复制

## 旧版复制功能的实现

同步和命令传播

### 同步

客户端 -> SLAVEOF命令 -> 服务器

1. 从服务器 -> SYNC命令 -> 主服务器
2. 主服务器执行BGSAVE命令，在后台生成RDB文件，使用缓冲区记录从现在开始执行的所有写命令
3. BGSAVE命令执行完，将RDB文件-> 从服务器。从服务器载入RDB文件，更新自己数据库的状态和主服务器执行BGSAVE时的状态
4. 主服务器->缓冲区记录-> 从服务器，从服务器执行这些写命令，更新状态

### 命令传播

主服务器将自己执行的写命令，发送给从服务器执行。从服务器执行之后，主从服务器恢复一致状态。

## 旧版复制功能的缺陷

初次复制和断线后重新复制，都要从头开始复制，第二种情况下，效率比较低。

## 新版复制功能的实现

PSYNC命令具有两种模式，完整重同步和部分重同步。

其中完整重同步，与旧版复制一样。
部分重同步就是为了解决断线后重新复制的情况。仅执行断线期间的写命令。

## 部分重同步的实现

几个概念： 主服务器的复制偏移量和从服务器的复制偏移量、主服务器的复制积压缓冲区、服务器的运行ID

### 复制偏移量

通过主从服务器的复制偏移量对比，确认两者状态是否一致

### 复制积压缓冲区

复制积压缓冲区是一个主服务器维护的固定长度先进先出的队列，默认1G。

如果offset偏移量之后的数据仍然存在复制积压缓冲区中，可以执行部分重同步操作。

### 服务器运行ID

每个服务器都有自己的运行ID
运行ID在服务器启动时自动生成，由40个随机的十六进制字符组成。

在从服务器对主服务器进行初次复制时，主服务器会将自己的运行ID发送给从服务器，从服务器将它存起来。

通过运行ID的对比，来确认是否可以进行部分重同步，一致则可以尝试部分重同步。否则就要进行完整重同步。

### PSYNC命令的实现

1. 没复制过，或者之前执行过SLAVEOF no one命令，则从服务器开始一次新的复制时发送PSYNC ？-1命令，主动请求进行完整重同步。
2. 已经复制过，在进行复制时发送PSYNC runid offset命令，主服务器来判断进行哪种重同步。

主服务器回复：

1. FULLRESYNC runid offset：执行完整重同步
2. CONTINUE：执行部分重同步
3. ERR: 无法识别命令，使用SYNC命令进行完整重同步

## 复制的实现

SLAVEOF master_ip master_port

1. 设置主服务器的地址和端口
2. 建立套接字连接
3. 发送PING命令
4. 身份验证
5. 发送端口信息
6. 同步
7. 命令传播

## 心跳检测

REPLCONF ACK replication_offset

1. 检测主从服务器的网络连接状态
2. 辅助实现min-slaves选项
3. 检测命令丢失
