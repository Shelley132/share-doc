## 消息队列的特点
1. 解耦
2. 最终一致性： 记录和补偿的方式
3. 广播
4. 错峰与流控

## 实现队列基本功能
1. RPC通信协议：依赖现有rpc框架
2. 高可用：mq保证处理消息幂等（共享存储等方式），将MQ的高可用转嫁为rpc的高可用
3. 服务端承载消息堆积的能力：存储（持久化和非持久化）
4. 存储子系统的选择
5. 消费关系解析：发送关系的维护、发送关系变更时端通知


## 分布式事务的实现
- 2PC（Two-phase Commit，二阶段提交）
- TCC（Try-Confirm-Cancel）
- 事务消息
    - 适用场景： 需要异步更新数据，并且对数据实时性要求不太高的场景
    - Kafka及RocketMQ提供了事务相关功能

## 消息队列是如何实现分布式事务的？
- 半消息
    在事务提交之前，对于消费者来说，这个消息不可见
    - 开启事务
    - 发送半消息
    - 执行本地事务
    - 提交或回滚
    - 投递消息

## RocketMQ中的分布式事务实现
利用事务反查机制解决了事务消息提交失败的问题。
1. MQ 发送方向 MQ Server 发送半消息
2. MQ Server 接收到半消息，则向 MQ 发送方返回发送成功
3. 执行本地事务
4. MQ 发送方向 MQ Server 提交或回滚半消息
5. MQ Server 未收到第4步中的确认时，回查事务状态
6. MQ 发送方检查本地事务的状态
7. 根据事务的状态提交或回滚
8. MQ Server 收到提交确认，则向 MQ 订阅方投递消息；否则删消息不进行投递

